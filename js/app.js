const scooterData = {
    "santiago": [
        {id: "S100", status: "Disponible", lat: -33.440462, lon: -70.639047, image: "https://placehold.co/100x100/78909C/ffffff?text=S100", battery: "100%"},
        {id: "S101", status: "Disponible", lat: -33.470275, lon: -70.658510, image: "https://placehold.co/100x100/78909C/ffffff?text=S101", battery: "100%"},
        {id: "S102", status: "En Uso", lat: -33.466665,lon: -70.671575, image: "https://placehold.co/100x100/78909C/ffffff?text=S102", battery: "85%"},
        {id: "S103", status: "En Uso", lat: -33.457024, lon: -70.661652, image: "https://placehold.co/100x100/78909C/ffffff?text=S103", battery: "31%"},
        {id: "S104", status: "Bateria Baja", lat: -33.453234, lon: -70.656803, image: "https://placehold.co/100x100/78909C/ffffff?text=S104", battery: "4%"},
        {id: "S105", status: "En Mantenimiento", lat: -33.452293, lon: -70.658256, image: "https://placehold.co/100x100/78909C/ffffff?text=S105", battery: "0%"},
        {id: "S106", status: "Bateria Baja", lat: -33.453085, lon: -70.660419, image: "https://placehold.co/100x100/78909C/ffffff?text=S106", battery: "10%"},
        {id: "S107", status: "En Uso", lat: -33.453099, lon: -70.660507, image: "https://placehold.co/100x100/78909C/ffffff?text=S107", battery: "60%"},
        {id: "S108", status: "Disponible", lat: -33.446251, lon: -70.662528, image: "https://placehold.co/100x100/78909C/ffffff?text=S108", battery: "70%"},
        {id: "S109", status: "Bateria Baja", lat: -33.446256, lon: -70.662480, image: "https://placehold.co/100x100/78909C/ffffff?text=S109", battery: "30%"},
        {id: "S110", status: "Disponible", lat: -33.452577, lon: -70.657129, image: "https://placehold.co/100x100/78909C/ffffff?text=S110", battery: "90%"},
        {id: "S111", status: "En Mantenimiento", lat: -33.452552, lon: -70.657224, image: "https://placehold.co/100x100/78909C/ffffff?text=S111", battery: "25%"},
        {id: "S112", status: "Disponible", lat: -33.452584, lon: -70.657091, image: "https://placehold.co/100x100/78909C/ffffff?text=S112", battery: "70%"},
        {id: "S113", status: "En Uso", lat: -33.450738, lon: -70.657519, image: "https://placehold.co/100x100/78909C/ffffff?text=S113", battery: "100%"},
        {id: "S114", status: "En Uso", lat: -33.449351, lon: -70.650678, image: "https://placehold.co/100x100/78909C/ffffff?text=S114", battery: "65%"}
    ],
    "providencia": [
        {id: "S200", status: "Disponible", lat: -33.438536, lon: -70.607503, image: "https://placehold.co/100x100/78909C/ffffff?text=S200", battery: "100%"},
        {id: "S201", status: "En Uso", lat: -33.438542, lon: -70.607626, image: "https://placehold.co/100x100/78909C/ffffff?text=S201", battery: "35%"},
        {id: "S202", status: "Disponible", lat: -33.438014, lon: -70.604852, image: "https://placehold.co/100x100/78909C/ffffff?text=S202", battery: "70%"},
        {id: "S203", status: "En Uso", lat: -33.436587, lon: -70.599851, image: "https://placehold.co/100x100/78909C/ffffff?text=S203", battery: "93%"},
        {id: "S204", status: "En Uso", lat: -33.436529, lon: -70.599590, image: "https://placehold.co/100x100/78909C/ffffff?text=S204", battery: "67%"},
        {id: "S205", status: "Disponible", lat: -33.436667, lon: -70.600212, image: "https://placehold.co/100x100/78909C/ffffff?text=S205", battery: "80%"},
        {id: "S206", status: "Disponible", lat: -33.435988, lon: -70.596616, image: "https://placehold.co/100x100/78909C/ffffff?text=S206", battery: "100%"},
        {id: "S207", status: "En Uso", lat: -33.436222, lon: -70.595417, image: "https://placehold.co/100x100/78909C/ffffff?text=S207", battery: "50%"},
        {id: "S208", status: "Disponible", lat: -33.432701, lon: -70.595072, image: "https://placehold.co/100x100/78909C/ffffff?text=S208", battery: "100%"},
        {id: "S209", status: "Disponible", lat: -33.432594, lon: -70.594772, image: "https://placehold.co/100x100/78909C/ffffff?text=S209", battery: "100%"},
        {id: "S210", status: "Disponible", lat: -33.431377, lon: -70.590119, image: "https://placehold.co/100x100/78909C/ffffff?text=S210", battery: "100%"},
        {id: "S211", status: "En Uso", lat: -33.434342, lon: -70.596042, image: "https://placehold.co/100x100/78909C/ffffff?text=S211", battery: "80%"},
        {id: "S212", status: "Disponible", lat: -33.428280, lon: -70.618714, image: "https://placehold.co/100x100/78909C/ffffff?text=S212", battery: "100%"},
        {id: "S213", status: "Bateria Baja", lat: -33.428183, lon: -70.618660, image: "https://placehold.co/100x100/78909C/ffffff?text=S213", battery: "29%"},
        {id: "S214", status: "Disponible", lat: -33.427715, lon: -70.617058, image: "https://placehold.co/100x100/78909C/ffffff?text=S214", battery: "70%"}
    ],
    "las-condes": [
    {id: "S300", status: "Disponible", lat: -33.411500, lon: -70.575000, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S300", battery: "100%"},
    {id: "S301", status: "En Uso", lat: -33.408250, lon: -70.582100, image: "https://placehold.co/100x100/FFC107/ffffff?text=S301", battery: "45%"},
    {id: "S302", status: "Bateria Baja", lat: -33.415700, lon: -70.569500, image: "https://placehold.co/100x100/F44336/ffffff?text=S302", battery: "15%"},
    {id: "S303", status: "Disponible", lat: -33.405500, lon: -70.590000, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S303", battery: "78%"},
    {id: "S304", status: "En Uso", lat: -33.420800, lon: -70.559800, image: "https://placehold.co/100x100/FFC107/ffffff?text=S304", battery: "62%"},
    {id: "S305", status: "En Mantenimiento", lat: -33.424100, lon: -70.548200, image: "https://placehold.co/100x100/9E9E9E/ffffff?text=S305", battery: "0%"},
    {id: "S306", status: "Disponible", lat: -33.398000, lon: -70.595500, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S306", battery: "95%"},
    {id: "S307", status: "En Uso", lat: -33.430200, lon: -70.535000, image: "https://placehold.co/100x100/FFC107/ffffff?text=S307", battery: "30%"},
    {id: "S308", status: "Bateria Baja", lat: -33.418500, lon: -70.572300, image: "https://placehold.co/100x100/F44336/ffffff?text=S308", battery: "21%"},
    {id: "S309", status: "Disponible", lat: -33.400500, lon: -70.588000, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S309", battery: "85%"},
    {id: "S310", status: "En Mantenimiento", lat: -33.435000, lon: -70.560100, image: "https://placehold.co/100x100/9E9E9E/ffffff?text=S310", battery: "5%"},
    {id: "S311", status: "Disponible", lat: -33.422500, lon: -70.550500, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S311", battery: "100%"},
    {id: "S312", status: "En Uso", lat: -33.407000, lon: -70.579000, image: "https://placehold.co/100x100/FFC107/ffffff?text=S312", battery: "55%"},
    {id: "S313", status: "Disponible", lat: -33.414000, lon: -70.565000, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S313", battery: "90%"},
    {id: "S314", status: "En Uso", lat: -33.416815, lon: -70.541035, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S314", battery: "90%"}
    ],
    "estacion-central": [
    {id: "S400", status: "Disponible", lat: -33.453000, lon: -70.687000, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S400", battery: "100%"},
    {id: "S401", status: "En Uso", lat: -33.454200, lon: -70.690500, image: "https://placehold.co/100x100/FFC107/ffffff?text=S401", battery: "38%"},
    {id: "S402", status: "Bateria Baja", lat: -33.455900, lon: -70.680000, image: "https://placehold.co/100x100/F44336/ffffff?text=S402", battery: "20%"},
    {id: "S403", status: "Disponible", lat: -33.458500, lon: -70.695500, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S403", battery: "85%"},
    {id: "S404", status: "En Uso", lat: -33.460100, lon: -70.675100, image: "https://placehold.co/100x100/FFC107/ffffff?text=S404", battery: "65%"},
    {id: "S405", status: "En Mantenimiento", lat: -33.461500, lon: -70.689000, image: "https://placehold.co/100x100/9E9E9E/ffffff?text=S405", battery: "10%"},
    {id: "S406", status: "Disponible", lat: -33.465000, lon: -70.683200, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S406", battery: "92%"},
    {id: "S407", status: "En Uso", lat: -33.467800, lon: -70.699100, image: "https://placehold.co/100x100/FFC107/ffffff?text=S407", battery: "50%"},
    {id: "S408", status: "Disponible", lat: -33.469100, lon: -70.685500, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S408", battery: "70%"},
    {id: "S409", status: "Bateria Baja", lat: -33.470500, lon: -70.693000, image: "https://placehold.co/100x100/F44336/ffffff?text=S409", battery: "18%"},
    {id: "S410", status: "Disponible", lat: -33.462200, lon: -70.678800, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S410", battery: "100%"},
    {id: "S411", status: "En Uso", lat: -33.450100, lon: -70.682500, image: "https://placehold.co/100x100/FFC107/ffffff?text=S411", battery: "42%"},
    {id: "S412", status: "Disponible", lat: -33.456000, lon: -70.698000, image: "https://placehold.co/100x100/4CAF50/ffffff?text=S412", battery: "98%"},
    {id: "S413", status: "En Mantenimiento", lat: -33.468000, lon: -70.670000, image: "https://placehold.co/100x100/9E9E9E/ffffff?text=S413", battery: "0%"},
    {id: "S414", status: "En Uso", lat: -33.464430, lon: -70.693359, image: "https://placehold.co/100x100/9E9E9E/ffffff?text=S414", battery: "61%"}
]
};


//const btn = document.querySelector('#modalOpen');  Elimine esta linea ya que ahora si funcionan las tarjetas levi xd



const modal = document.querySelector('#scooterModal');
const nombreComuna = document.getElementById('modalComuna');
const contenedorTarjetas = document.getElementById('contenedor-tarjetas');
const comunaTarjetas = document.querySelectorAll('.comuna-card');

//Referencias al modal de reportes

const reportModal = document.getElementById('reportModal');
const reportSpan = document.getElementById('reportScooterSpan');
const comunaSpan = document.getElementById('comunaNombre');
const formularioReport = document.getElementById('reportForm');
const inputMensaje = document.getElementById('mensajeReport');
const btnCancelar = document.getElementById('btnCancelar');
const btnEnviar = document.getElementById('btnEnviar');

function statusCorrecionClase (status){
    return status.replace(/ /g, "");
};

function crearTarjetasScooter (scooter, comunaNombreTitulo){
    const statusClass = `status-${statusCorrecionClase(scooter.status)}`;
    const mapURL = `https://maps.google.com/maps?q=${scooter.lat},${scooter.lon}&z=18&output=embed`;
    
    return `
        <div class="scooter-info-card"> 
        
        <div class="scooter-img-container">
            <img src="img/volzeep-scooter.png" alt="Imagen del scooter">
        </div>
        
        <div class="info-vertical"> 
            <div class="num-serie">
                <strong>${scooter.id}</strong>
            </div> 
            <div class="reporte">
                <button type="button" class="btn-reportar">Reportar</button>
            </div> 
        </div>

        <div class="info-estado"> 
            <div class="estado-bateria">
                <div lass="estado-scooter">
                    <p class="status ${statusClass}">${scooter.status}</p>
                </div>
                <div class="bateria-scooter">
                    <p class="status bateria">${scooter.battery}</p>
                </div>
            </div>
        </div>
        <div class="ubicacion-scooter">
                <iframe src="${mapURL}" title="Mapa de ubicaciÃ³n del scooter"></iframe>
        </div>
     </div>
    `
}

function clickComuna(event){
    const tarjetaClickeada = event.currentTarget;

    const comunaKey = tarjetaClickeada.dataset.comuna; 

    const nombreh2 = tarjetaClickeada.querySelector('.card-overlay h2');

    const comunaNombreTitulo = nombreh2.textContent.trim();

    nombreComuna.textContent = comunaNombreTitulo;

    contenedorTarjetas.innerHTML = '';

    contenedorTarjetas.dataset.comunaNombre = comunaNombreTitulo;

    let tarjetaHTML = '';

    const scooters = scooterData[comunaKey];

    if(scooters.length > 0){
        scooters.forEach(scooter => {
            tarjetaHTML += crearTarjetasScooter(scooter, comunaNombreTitulo);
        });
    }

    contenedorTarjetas.innerHTML = tarjetaHTML;

    modal.showModal();
}

window.onload = function(){
    comunaTarjetas.forEach(tarjeta => {
        tarjeta.addEventListener('click', clickComuna);
    })
}

contenedorTarjetas.addEventListener('click', (e) =>{
    const botonReportar = e.target.closest('.btn-reportar');
    if(botonReportar){
        const scooterCard = botonReportar.closest('.scooter-info-card');
        const scooterID = scooterCard.querySelector('.num-serie strong').textContent.trim();
        const comunaNombre = contenedorTarjetas.dataset.comunaNombre;
        reportSpan.textContent = scooterID; 
        comunaSpan.textContent = comunaNombre;
        reportModal.showModal();
    }
})

btnCancelar.addEventListener('click', () =>{
    reportModal.close();
})


btnEnviar.addEventListener('click', (e) => {
    e.preventDefault();

    const scooterID = reportSpan.textContent.trim();
    const comunaNombre = comunaSpan.textContent.trim();

    const textReport = document.getElementById('mensajeReport').value;

    if(!textReport){
        alert("Debes ingresar un reporte!");
        return;
    }

    const reportObject = {
        idScooter: scooterID,
        comuna: comunaNombre,
        reporte: textReport
    }



    enviarReporte(reportObject);
});

    async function enviarReporte(reportObject){
        const URL = "/reportes/create";

        try{ 
            const respuesta = await fetch(URL,{
                method: "POST",
                headers: {
                   "Content-Type" : "application/json" 
                },
                body: JSON.stringify(reportObject)
            })

            if(respuesta.ok){
                reportModal.close();
                document.getElementById('mensajeReport').value = '';
            }else{
                alert("Error al enviar el reporte");
            }


        }catch(error){
            console.log("Ocurrio un error: "+ error);
        }
    }